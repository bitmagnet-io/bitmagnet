<ng-container *transloco="let t">
  @if (getAttribute("poster_path", "tmdb"); as posterPath) {
    <img
      [ngSrc]="'https://image.tmdb.org/t/p/w300/' + posterPath"
      [alt]="t('torrents.poster')"
      class="poster"
      [width]="breakpoints.sizeAtLeast('Medium') ? 300 : 150"
      [height]="breakpoints.sizeAtLeast('Medium') ? 450 : 225"
    />
  }
  @if (heading) {
    <h2>
      <a
        [href]="'torrents/' + torrentContent.infoHash"
        [matTooltip]="t('torrents.permalink')"
        >{{ torrentContent.torrent.name }}</a
      >
    </h2>
  }
  @if (size) {
    <p class="size">
      <strong>{{ t("torrents.size") }}:</strong>
      {{ torrentContent.torrent.size | filesize | humanTime: transloco.getActiveLang() }}
    </p>
  }
  @if (published) {
    <p class="published">
      <strong>{{ t("torrents.published") }}</strong>
      {{ torrentContent.publishedAt | humanTime: transloco.getActiveLang() }}
    </p>
  }
  @if (peers) {
    <p class="peers">
      <strong>{{ t("torrents.s_l") }}:</strong>
      {{ torrentContent.seeders ?? "?" }} / {{ torrentContent.leechers ?? "?" }}
    </p>
  }
  <p class="info-hash">
    <strong>{{ t("torrents.info_hash") }}:</strong>
    <span
      [matTooltip]="t('torrents.copy_to_clipboard')"
      [cdkCopyToClipboard]="torrentContent.infoHash"
      >{{ torrentContent.infoHash }}</span
    >
  </p>
  <p>
    <strong>{{ t("torrents.source") }}:</strong>&nbsp;
    @for (s of torrentContent.torrent.sources; let j = $index; track s.key) {
      <span>{{ (j > 0 ? ", " : "") + s.name }}</span>
    }
  </p>
  @if (torrentContent.content) {
    <p>
      <strong>{{ t("torrents.title") }}:</strong>
      {{ torrentContent.content.title }}
    </p>
  }
  @if (torrentContent.languages?.length) {
    <p>
      <strong>{{ t("torrents.languages") }}:</strong>&nbsp;
      @for (l of torrentContent.languages; let j = $index; track l.id) {
        {{
          (j > 0 ? ", " : "") +
            l.name +
            (l.id === torrentContent.content?.originalLanguage?.id
              ? " (original)"
              : "")
        }}
      }
    </p>
  }
  @if (torrentContent.content?.releaseYear) {
    <p>
      <strong>{{ t("torrents.original_release_date") }}:</strong>
      {{
        torrentContent.content?.releaseDate ??
          torrentContent.content?.releaseYear
      }}
    </p>
  }
  @if (torrentContent.episodes) {
    <p>
      <strong>{{ t("torrents.episodes") }}:</strong>
      {{ torrentContent.episodes!.label }}
    </p>
  }
  @if (torrentContent.content?.overview) {
    <p>
      {{ torrentContent.content!.overview }}
    </p>
  }
  @if (getCollections("genre"); as genres) {
    <ng-container>
      <p>
        <strong>{{ t("torrents.genres") }}:</strong> {{ genres.join(", ") }}
      </p>
    </ng-container>
  }
  @if (torrentContent.content?.voteAverage != null) {
    <p>
      <strong>{{ t("torrents.rating") }}:</strong>
      {{ torrentContent.content?.voteAverage }} / 10
      @if (torrentContent.content?.voteCount != null) {
        <ng-container
          >({{
            t("torrents.votes_count_n", {
              count: torrentContent.content?.voteCount | number
            })
          }})</ng-container
        >
      }
    </p>
  }
  @if (torrentContent.content?.externalLinks; as externalLinks) {
    <p>
      <strong>{{ t("torrents.external_links") }}:</strong>&nbsp;
      @for (l of externalLinks; let j = $index; track l.metadataSource.key) {
        {{ j > 0 ? ", " : ""
        }}<a [href]="l.url" target="_blank">{{ l.metadataSource.name }}</a>
      }
    </p>
  }

  <mat-divider style="clear: both"></mat-divider>

  <mat-tab-group
    animationDuration="0"
    [selectedIndex]="selectedTabIndex"
    (focusChange)="selectTab($event.index == 4 ? 0 : $event.index)"
    [mat-stretch-tabs]="false"
  >
    <mat-tab aria-labelledby="hidden"></mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>file_present</mat-icon>
        @if (!breakpoints.sizeAtLeast('Medium')) {
          <span class="label">{{ t("torrents.files") }}</span>
        }
        @if (filesCount(); as filesCount) {
          <span class="files-count">({{ filesCount | number }})</span>
        }
      </ng-template>

      <ng-template matTabContent>
        <mat-card class="torrent-files">
          @if (torrentContent.torrent.filesStatus === "no_info") {
            <p>{{ t("torrents.files_no_info") }}</p>
          }
          @if (torrentContent.torrent.filesStatus === "single") {
            <p>
              <strong>{{ t("torrents.files_single") }}:</strong>
              {{ torrentContent.torrent.name }}<br />
              @if (torrentContent.torrent.fileType; as ft) {
                <span
                  ><strong>{{ t("torrents.file_type") }}: </strong>
                  {{ ft!.charAt(0).toUpperCase() + ft!.slice(1) }}<br
                /></span>
              }
              <strong>{{ t("torrents.file_size") }}:</strong>
              {{ torrentContent.torrent.size | filesize }}
            </p>
          }
          @if (torrentContent.torrent.filesStatus === "multi") {
            <p>
              {{
                t("torrents.files_count_n", {
                  count: torrentContent.torrent.files?.length | number
                })
              }}
            </p>
          }
          @if (torrentContent.torrent.filesStatus === "over_threshold") {
            <p>
              {{
                t("torrents.showing_x_of_y_files", {
                  x: torrentContent.torrent.files?.length | number,
                  y:
                    torrentContent.torrent.filesCount == null
                      ? "?"
                      : (torrentContent.torrent.filesCount | number)
                })
              }}
            </p>
          }
          @if (torrentContent.torrent.files?.length) {
            <table>
              <thead>
                <tr>
                  <th>{{ t("torrents.file_path") }}</th>
                  <th>{{ t("torrents.file_type") }}</th>
                  <th>{{ t("torrents.file_size") }}</th>
                </tr>
              </thead>
              <tbody>
                @for (f of torrentContent.torrent.files; track f.path) {
                  <tr>
                    <td class="table-torrent-files-td-file">
                      {{ f.path }}
                    </td>
                    <td>
                      {{
                        t("file_types." + (f.fileType ? f.fileType : "unknown"))
                      }}
                    </td>
                    <td class="table-torrent-files-td-size">
                      {{ f.size | filesize }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </mat-card>
      </ng-template>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>sell</mat-icon>
        @if (breakpoints.sizeAtLeast('Medium')) {
          <span class="label">{{ t("torrents.edit_tags") }}</span>
        }
      </ng-template>
      <ng-template matTabContent>
        <mat-card>
          <mat-form-field class="form-edit-tags" subscriptSizing="dynamic">
            <mat-chip-grid #chipGrid>
              @for (
                tagName of torrentContent.torrent.tagNames;
                let j = $index;
                track tagName
              ) {
                <mat-chip-row
                  [editable]="true"
                  (edited)="renameTag(tagName, $event.value)"
                  (removed)="deleteTag(tagName)"
                >
                  {{ tagName }}
                  <mat-icon matChipRemove>cancel</mat-icon>
                </mat-chip-row>
              }
            </mat-chip-grid>
            <input
              [placeholder]="t('torrents.new_tag')"
              [formControl]="newTagCtrl"
              [matAutocomplete]="auto"
              [matChipInputFor]="chipGrid"
              [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
              (matChipInputTokenEnd)="$event.value && addTag($event.value)"
              [value]="newTagCtrl.value"
              autocapitalize="none"
            />
            <mat-autocomplete
              #auto="matAutocomplete"
              (optionSelected)="addTag($event.option.viewValue)"
            >
              @for (tagName of suggestedTags; track tagName) {
                <mat-option [value]="tagName">{{ tagName }}</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
        </mat-card>
      </ng-template>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>delete_forever</mat-icon>
        @if (breakpoints.sizeAtLeast('Medium')) {
          <span class="label">{{ t("torrents.delete") }}</span>
        }
      </ng-template>

      <ng-template matTabContent>
        <mat-card>
          <mat-card-content style="margin-top: 10px">
            <p>
              <strong>{{ t("torrents.delete_are_you_sure") }}</strong>
              <br />{{ t("torrents.delete_action_cannot_be_undone") }}
            </p>
          </mat-card-content>
          <mat-card-actions class="button-row">
            <button mat-stroked-button color="warn" (click)="delete()">
              <mat-icon>delete_forever</mat-icon>{{ t("torrents.delete") }}
            </button>
          </mat-card-actions>
        </mat-card>
      </ng-template>
    </mat-tab>
    @if (selectedTabIndex > 0) {
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon style="margin-right: 0">close</mat-icon>
        </ng-template>
      </mat-tab>
    }
  </mat-tab-group>
</ng-container>
