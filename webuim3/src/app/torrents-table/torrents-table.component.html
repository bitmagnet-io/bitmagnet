<ng-container *transloco="let t">
  <div class="progress-bar-container">
    @if (dataSource.loading$ | async) {
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    }
  </div>
<table
  mat-table
  [dataSource]="dataSource"
  [multiTemplateDataRows]="true"
  class="table-results"
>
  <!-- Checkbox Column -->
  <ng-container matColumnDef="select">
    <th mat-header-cell *matHeaderCellDef>
      <mat-checkbox
        (change)="toggleAllRows()"
        [checked]="selection.hasValue() && isAllSelected()"
        [indeterminate]="selection.hasValue() && !isAllSelected()"
        [matTooltip]="isAllSelected() ? t('torrents.deselect_all') : t('torrents.select_all')"
      >
      </mat-checkbox>
    </th>
    <td mat-cell *matCellDef="let i">
      <mat-checkbox
        (click)="$event.stopPropagation()"
        (change)="$event ? selection.toggle(item(i).infoHash) : null"
        [checked]="selection.isSelected(item(i).infoHash)"
      >
      </mat-checkbox>
    </td>
  </ng-container>

  <ng-container matColumnDef="summary">
    <th mat-header-cell *matHeaderCellDef>{{ t("torrents.summary") }}</th>
    <td
      mat-cell
      *matCellDef="let i"
      (click)="toggleTorrentContentId(i.id); $event.stopPropagation()"
    >
      <mat-icon
        [matTooltip]="t('content_types_singular.' + (item(i).contentType ?? 'null'))"
      >{{
          contentTypeInfo(item(i).contentType)?.icon ?? "question_mark"
        }}</mat-icon
      >
      <span class="title">{{ item(i).title }}</span>
      <mat-chip-set>
        @for (tagName of item(i).torrent.tagNames; track tagName) {
          <mat-chip class="chip-primary">
            <mat-icon matChipAvatar>sell</mat-icon>
            {{ tagName }}
          </mat-chip>
        }
        @if (item(i).languages; as languages) {
          <mat-chip>
            <mat-icon matChipAvatar>translate</mat-icon>
            @for (l of languages; let j = $index; track l.id) {
              <ng-container>
                {{ j > 0 ? ", " : "" }}{{ t('languages.'+l.id) }}
              </ng-container>
            }
          </mat-chip>
        }
        @if (item(i).video3d?.slice(1); as video3d) {
          <mat-chip>{{ video3d }}</mat-chip>
        }
        @if (item(i).videoResolution?.slice(1); as videoResolution) {
          <mat-chip><mat-icon matChipAvatar>screenshot_monitor</mat-icon>{{ videoResolution }}</mat-chip>
        }
        @if (item(i).videoSource; as videoSource) {
          <mat-chip><mat-icon matChipAvatar>album</mat-icon>{{ videoSource }}</mat-chip>
        }
        @if (item(i).videoCodec; as videoCodec) {
          <mat-chip>{{ videoCodec }}</mat-chip>
        }
        @if (item(i).videoModifier; as videoModifier) {
          <mat-chip>{{ videoModifier }}</mat-chip>
        }
      </mat-chip-set>
    </td>
  </ng-container>

  <ng-container matColumnDef="size">
    <th mat-header-cell *matHeaderCellDef>{{t("torrents.size")}}</th>
    <td mat-cell *matCellDef="let i">
      {{ item(i).torrent.size | filesize }}
    </td>
  </ng-container>

  <ng-container matColumnDef="publishedAt">
    <th mat-header-cell *matHeaderCellDef>{{t("torrents.published")}}</th>
    <td class="td-published-at" mat-cell *matCellDef="let i">
      <abbr
        matTooltip="{{ item(i).publishedAt }}"
        matTooltipClass="tooltip-published-at"
      >
        {{ item(i).publishedAt | humanTime }}
      </abbr>
    </td>
  </ng-container>

  <ng-container matColumnDef="peers">
    <th mat-header-cell *matHeaderCellDef>
      <abbr [matTooltip]="t('torrents.seeders') + ' / ' + t('torrents.leechers')">{{t("torrents.s_l")}}</abbr>
    </th>
    <td mat-cell *matCellDef="let i">
      {{ item(i).seeders ?? "?" }} /
      {{ item(i).leechers ?? "?" }}
    </td>
  </ng-container>

  <ng-container matColumnDef="magnet">
    <th mat-header-cell *matHeaderCellDef style="text-align: center">
      {{t("torrents.magnet")}}
    </th>
    <td mat-cell *matCellDef="let i">
      <a href="{{ item(i).torrent.magnetUri }}"
      ><mat-icon svgIcon="magnet"></mat-icon
      ></a>
    </td>
  </ng-container>

  <ng-container matColumnDef="expandedDetail">
    <td
      mat-cell
      *matCellDef="let i"
      [attr.colspan]="displayedColumns.length"
    >
      <div
        class="item-detail"
        [@detailExpand]="
                expandedTorrentContentId === i.id ? 'expanded' : 'collapsed'
              "
      >
        <app-torrent-content-content
        [torrentContent]="i"
        (updated)="updated.emit(item(i).infoHash)"
      />
      </div>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr
    mat-row
    *matRowDef="let i; columns: displayedColumns"
    [class]="
            'summary-row ' +
            (i.id === expandedTorrentContentId ? 'expanded' : 'collapsed')
          "
  ></tr>
  <tr
    mat-row
    *matRowDef="let _; columns: ['expandedDetail']"
    class="expanded-detail-row"
  ></tr>
</table>
</ng-container>
