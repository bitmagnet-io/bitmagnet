import{a as je}from"./chunk-7XK2G5MK.js";import{a as Ae,b as Qe,c as Ue,d as Ge}from"./chunk-RIASOBPL.js";import{d as Re,e as M,f as ze,g as B,h as D,i as He,j as Ne}from"./chunk-T7M4FD7R.js";import{a as Fe,b as Ve}from"./chunk-GGOWWLDY.js";import"./chunk-RQ2LQKI2.js";import{a as De,b as Le}from"./chunk-57HNGHIP.js";import"./chunk-42PJPEMD.js";import{a as ge}from"./chunk-EQNSMMUR.js";import{a as Be}from"./chunk-QR7MAH7E.js";import{a as qe}from"./chunk-QW6FNWRP.js";import{$ as Ce,Aa as Te,Ba as ve,D as ue,E as de,Fa as Me,Ga as Pe,Na as we,Oa as Oe,Pa as Ee,Qa as ke,Ra as $e,T as fe,Y as he,_ as xe,a as oe,b as re,h as ae,hb as Ie,k as ce,l as le,m as se,o as pe,qa as Se,r as me,ya as be,z as _e,za as ye}from"./chunk-HFKQOR7T.js";import"./chunk-6XXA7HXI.js";import{i as ne,k as ie}from"./chunk-WWUTX2BO.js";import{$ as G,$b as l,Ac as F,B as w,Cb as h,Ea as _,Fa as u,Gb as Y,Hb as d,Kb as j,Mb as C,N as Q,O as U,Ob as k,Pb as $,Qb as s,Rb as p,Sb as V,Tb as J,Ub as K,Wb as O,Zb as g,a as f,b as T,dd as te,jc as A,kb as c,kc as m,l as E,lc as S,mc as x,o as N,qa as v,sc as X,ua as W,uc as Z,xc as ee,yc as b,zc as I}from"./chunk-PHIAEVDB.js";var L=(t,o)=>{let i=y(t,o)?.split(",").map(n=>n.trim()).filter(Boolean);return i?.length?Array.from(new Set(i)).sort():void 0},y=(t,o)=>typeof t[o]=="string"&&decodeURIComponent(t[o])||void 0,R=(t,o)=>{if(t&&t[o]&&/^\d+$/.test(t[o]))return parseInt(t[o])};var z={items:[],totalCount:0,totalCountIsEstimate:!1,aggregations:{}},q=class{constructor(o,e,i){this.apollo=o,this.errorsService=e,this.currentRequest=new E(0),this.loadingSubject=new E(!1),this.loading$=this.loadingSubject.asObservable(),this.result=z,this.resultSubject=new E(this.result),this.result$=this.resultSubject.asObservable(),this.items$=this.resultSubject.pipe(w(n=>n.items)),this.overallTotalCount$=this.resultSubject.pipe(w(n=>{let a=0,r=!1;for(let P of n.aggregations.contentType??[])a+=P.count,r=r||P.isEstimate;return{count:a,isEstimate:r}})),this.availableContentTypes$=this.resultSubject.pipe(G((n,a)=>Array.from(new Set([...n,...(a.aggregations.contentType??[]).flatMap(r=>r.value?[r.value]:[])])),[])),this.contentTypeCounts$=this.resultSubject.pipe(w(n=>Object.fromEntries((n.aggregations.contentType??[]).map(a=>[a.value,{count:a.count,isEstimate:a.isEstimate}])))),i.subscribe(n=>{this.input=n.input,this.loadResult({input:T(f({},n.input),{cached:!0})})}),this.resultSubject.subscribe(n=>{this.result=n})}connect({}){return this.items$}disconnect(){this.resultSubject.complete()}refresh(){this.loadResult({input:T(f({},this.input),{cached:!1})})}loadResult(o){this.currentSubscription&&(this.currentSubscription.unsubscribe(),this.currentSubscription=void 0),this.loadingSubject.next(!0);let e=this.currentRequest.getValue()+1;this.currentRequest.next(e);let i=this.apollo.query({query:fe,variables:o,fetchPolicy:"no-cache"}).pipe(w(n=>n.data.torrentContent.search)).pipe(Q(n=>(this.errorsService.addError(`Error loading item results: ${n.message}`),N)));this.currentSubscription=i.subscribe(n=>{e===this.currentRequest.getValue()&&(this.loadingSubject.next(!1),this.resultSubject.next(n))})}};var We=(t,o)=>o.key,Xe=(t,o)=>o.field,Ye=(t,o)=>o.value,Ze=t=>({x:t}),et=(t,o,e,i)=>[t,o,e,i];function tt(t,o){if(t&1&&(s(0,"small"),m(1),b(2,"intEstimate"),p()),t&2){let e=o;c(),x(" ",F(2,1,e.count,e.isEstimate)," ")}}function nt(t,o){if(t&1&&(s(0,"small"),m(1),b(2,"intEstimate"),p()),t&2){let e=o;c(),S(F(2,1,e.count,e.isEstimate))}}function it(t,o){t&1&&(s(0,"small"),m(1,"0"),p())}function ot(t,o){if(t&1){let e=O();s(0,"li",6),g("click",function(){_(e);let n=l().$implicit,a=l(2);return u(a.controller.selectContentType(n.key))}),s(1,"mat-icon"),m(2),p(),m(3),h(4,nt,3,4,"small"),b(5,"async"),h(6,it,2,0,"small"),p()}if(t&2){let e,i=l().$implicit,n=l().$implicit,a=l();j(a.controls.contentType===i.key?"active":""),c(2),S(i.icon),c(),x(" ",n("content_types.plural."+i.key)," "),c(),C((e=(e=I(5,5,a.dataSource.contentTypeCounts$))==null?null:e[i.key])?4:6,e)}}function rt(t,o){if(t&1&&(h(0,ot,7,7,"li",24),b(1,"async")),t&2){let e,i=o.$implicit,n=l(2);C(i.key==="null"||(e=I(1,1,n.dataSource.availableContentTypes$))!=null&&e.includes(i.key)?0:-1)}}function at(t,o){if(t&1){let e=O();s(0,"mat-checkbox",30),g("change",function(n){let a=_(e).$implicit,r=l(3).$implicit,P=l(2);return u(n.checked?P.controller.activateFilter(r,a.value):P.controller.deactivateFilter(r,a.value))}),m(1),s(2,"small"),m(3),b(4,"intEstimate"),p()()}if(t&2){let e=o.$implicit,i=l(3).$implicit;d("checked",i.filter==null?null:i.filter.includes(e.value)),c(),x(" ",e.label," "),c(2),S(F(4,3,e.count,e.isEstimate))}}function ct(t,o){if(t&1&&(s(0,"section",27),k(1,at,5,6,"mat-checkbox",29,Ye),p()),t&2){let e=l(2).$implicit;c(),$(e.aggregations)}}function lt(t,o){if(t&1){let e=O();s(0,"mat-checkbox",32),g("change",function(){let n=_(e).$implicit,a=l(4).$implicit,r=l(2);return u(r.controller.activateFilter(a,n.value))}),m(1),s(2,"small"),m(3),b(4,"intEstimate"),p()()}if(t&2){let e=o.$implicit;c(),x(" ",e.label," "),c(2),S(F(4,2,e.count,e.isEstimate))}}function st(t,o){if(t&1&&k(0,lt,5,5,"mat-checkbox",31,Ye),t&2){let e=l(3).$implicit;$(e.aggregations)}}function pt(t,o){if(t&1&&m(0),t&2){let e=l(4).$implicit;x(" ",e("general.none")," ")}}function mt(t,o){if(t&1&&(s(0,"section",28),h(1,st,2,0)(2,pt,1,1),p()),t&2){let e=l(2).$implicit;c(),C(e.aggregations.length?1:2)}}function _t(t,o){if(t&1){let e=O();s(0,"mat-expansion-panel",26),g("opened",function(){_(e);let n=l().$implicit,a=l(2);return u(a.controller.activateFacet(n))})("closed",function(){_(e);let n=l().$implicit,a=l(2);return u(a.controller.deactivateFacet(n))}),s(1,"mat-expansion-panel-header")(2,"mat-panel-title")(3,"mat-icon"),m(4),p(),m(5),p()(),h(6,ct,3,0,"section",27)(7,mt,3,1,"section",28),p()}if(t&2){let e=l().$implicit,i=l().$implicit;d("expanded",e.active),c(4),S(e.icon),c(),x(" ",i("facets."+e.key)," "),c(),C(e.filter!=null&&e.filter.length?6:7)}}function ut(t,o){if(t&1&&h(0,_t,8,4,"mat-expansion-panel",25),t&2){let e=o.$implicit;C(e.relevant?0:-1)}}function dt(t,o){if(t&1){let e=O();s(0,"button",18),g("click",function(){_(e);let n=l(2);return n.queryString.reset(),u(n.controller.setQueryString(null))}),s(1,"mat-icon"),m(2,"close"),p()()}if(t&2){let e=l().$implicit;d("matTooltip",e("torrents.clear_search"))}}function gt(t,o){if(t&1&&(s(0,"mat-option",33),m(1),p()),t&2){let e=l().$implicit,i=l().$implicit;d("value",e.field),c(),x(" ",i("torrents.ordering."+e.field)," ")}}function ft(t,o){if(t&1&&h(0,gt,2,2,"mat-option",33),t&2){let e=o.$implicit,i=l(2);C(e.field!="relevance"||i.queryString.value?0:-1)}}function ht(t,o){if(t&1){let e=O();J(0),V(1,"app-document-title",2),s(2,"mat-drawer-container",3)(3,"mat-drawer",4,0)(5,"mat-expansion-panel",5)(6,"mat-expansion-panel-header")(7,"mat-panel-title")(8,"mat-icon"),m(9,"interests"),p(),m(10),p()(),s(11,"section")(12,"nav")(13,"ul")(14,"li",6),g("click",function(){_(e);let n=l();return u(n.controller.selectContentType(null))}),s(15,"mat-icon",7),m(16,"emergency"),p(),m(17),h(18,tt,3,4,"small"),b(19,"async"),p(),k(20,rt,2,3,null,null,We),p()()()(),k(22,ut,1,1,null,null,We),b(24,"async"),p(),s(25,"mat-drawer-content")(26,"div",8)(27,"div",9)(28,"button",10),g("click",function(){_(e);let n=A(4);return u(n.toggle())}),s(29,"mat-icon",11),m(30),p()()(),s(31,"div",12)(32,"mat-form-field",13)(33,"input",14),g("keyup.enter",function(){_(e);let n=l();return u(n.controller.setQueryString(n.queryString.value))}),p(),h(34,dt,3,1,"button",15),p()(),s(35,"div",16)(36,"mat-form-field",13)(37,"mat-label"),m(38),p(),s(39,"mat-select",17),g("valueChange",function(n){_(e);let a=l();return u(a.controller.selectOrderBy(n))}),k(40,ft,1,1,null,null,Xe),p()(),s(42,"button",18),g("click",function(){_(e);let n=l();return u(n.controller.toggleOrderByDirection())}),s(43,"mat-icon"),m(44),p()()(),s(45,"div",19)(46,"button",20),g("click",function(){_(e);let n=l();return u(n.dataSource.refresh())}),s(47,"mat-icon"),m(48,"sync"),p()()()(),V(49,"mat-divider"),s(50,"app-torrents-bulk-actions",21),g("updated",function(){_(e);let n=l();return u(n.dataSource.refresh())}),p(),V(51,"mat-divider"),s(52,"app-torrents-table",22),g("updated",function(){_(e);let n=l();return u(n.dataSource.refresh())}),p(),s(53,"app-paginator",23),g("paging",function(n){_(e);let a=l();return u(a.controller.handlePageEvent(n))}),p()()(),K()}if(t&2){let e,i,n=o.$implicit,a=A(4),r=l();c(),d("parts",ee(37,et,r.controls.queryString,((e=r.controls.contentType)!==null&&e!==void 0?e:"null")==="null"?null:n("content_types.plural."+r.controls.contentType),r.controls.page>1?n("paginator.page_x",Z(35,Ze,r.controls.page)):null,n("routes.torrents"))),c(2),d("mode",r.breakpoints.sizeAtLeast("Medium")?"side":"over")("opened",r.breakpoints.sizeAtLeast("Medium")),Y("role",r.breakpoints.sizeAtLeast("Medium")?"navigation":"dialog"),c(2),d("expanded",r.breakpoints.sizeAtLeast("Medium")),c(5),x(" ",n("facets.content_type")," "),c(4),j(r.controls.contentType===null?"active":""),c(3),x("",n("content_types.plural.all")," "),c(),C((i=I(19,31,r.dataSource.overallTotalCount$))?18:-1,i),c(2),$(r.contentTypes),c(2),$(I(24,33,r.facets$)),c(6),d("matTooltip",n("torrents.toggle_drawer")),c(2),S(a.opened?"arrow_circle_left":"arrow_circle_right"),c(3),d("placeholder",n("torrents.search"))("formControl",r.queryString),c(),C(r.queryString.value?34:-1),c(4),S(n("torrents.order_by")),c(),d("value",r.controls.orderBy.field),c(),$(r.orderByOptions),c(2),d("matTooltip",n("torrents.order_direction_toggle")),c(2),S(r.controls.orderBy.descending?"arrow_downward":"arrow_upward"),c(2),d("matTooltip",n("torrents.refresh")),c(4),d("selectedItems$",r.selectedItems$),c(2),d("dataSource",r.dataSource)("controller",r.controller)("displayedColumns",r.breakpoints.sizeAtLeast("Medium")?r.allColumns:r.compactColumns)("multiSelection",r.multiSelection),c(),d("page",r.controls.page)("pageSize",r.controls.limit)("pageLength",r.dataSource.result.items.length)("totalLength",r.dataSource.result.totalCount)("totalIsEstimate",r.dataSource.result.totalCountIsEstimate)("hasNextPage",r.dataSource.result.hasNextPage)}}var gn=(()=>{class t{constructor(){this.route=v(ne),this.router=v(ie),this.apollo=v(ae),this.errorsService=v(ge),this.transloco=v(oe),this.aggregationBudget=v(je),this.breakpoints=v(Be),this.controls=Je,this.contentTypes=Le,this.orderByOptions=D,this.allColumns=Ue,this.compactColumns=Ge,this.queryString=new se(""),this.result=z,this.multiSelection=new me(!0,[]),this.selectedItemsSubject=new E([]),this.selectedItems$=this.selectedItemsSubject.asObservable(),this.subscriptions=Array(),this.controller=new ze(this.controls),this.dataSource=new q(this.apollo,this.errorsService,this.controller.params$),this.subscriptions.push(this.controller.controls$.subscribe(e=>{this.controls=e})),this.facets$=this.controller.controls$.pipe(U(this.dataSource.result$),w(([e,i])=>B.map(n=>T(f(f({},n),n.extractInput(e.facets)),{relevant:!n.contentTypes||!!(e.contentType&&e.contentType!=="null"&&n.contentTypes.includes(e.contentType)),aggregations:n.extractAggregations(i.aggregations).map(a=>T(f({},a),{label:n.resolveLabel(a,this.transloco)}))})))),this.subscriptions.push(this.dataSource.result$.subscribe(e=>{this.result=e;let i=new Set(e.items.map(({infoHash:n})=>n));this.multiSelection.deselect(...this.multiSelection.selected.filter(n=>!i.has(n)))}))}ngOnInit(){this.subscriptions.push(this.route.queryParams.subscribe(e=>{this.queryString.setValue(y(e,"query")??null),this.controller.update(()=>xt(e))}),this.controller.controls$.subscribe(e=>{this.router.navigate([],{relativeTo:this.route,queryParams:Ct(e),queryParamsHandling:"replace"})}),this.multiSelection.changed.subscribe(e=>{let i=new Set(e.source.selected);this.selectedItemsSubject.next(this.result.items.filter(n=>i.has(n.infoHash)))}),this.aggregationBudget.getBudget().subscribe(e=>{this.controller.update(i=>T(f({},i),{aggregationBudget:e}))}))}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe()),this.subscriptions=new Array}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275cmp=W({type:t,selectors:[["app-torrents-search"]],standalone:!0,features:[X],decls:1,vars:0,consts:[["drawer",""],[4,"transloco"],[3,"parts"],[1,"drawer-container"],[1,"drawer",3,"mode","opened"],[1,"panel-content-type",3,"expanded"],[3,"click"],["fontSet","material-icons"],[1,"search-form"],[1,"form-field-container","button-container","button-container-toggle-drawer"],["type","button","mat-icon-button","",1,"button-toggle-drawer",3,"click","matTooltip"],["aria-label","Side nav toggle icon","fontSet","material-icons"],[1,"form-field-container","form-field-container-search-query"],["subscriptSizing","dynamic"],["matInput","","autocapitalize","none",3,"keyup.enter","placeholder","formControl"],["mat-icon-button","",3,"matTooltip"],[1,"form-field-container","form-field-container-order-by"],[3,"valueChange","value"],["mat-icon-button","",3,"click","matTooltip"],[1,"form-field-container","button-container","button-container-refresh"],["mat-mini-fab","","color","primary",3,"click","matTooltip"],[3,"updated","selectedItems$"],[3,"updated","dataSource","controller","displayedColumns","multiSelection"],[3,"paging","page","pageSize","pageLength","totalLength","totalIsEstimate","hasNextPage"],[3,"class"],[3,"expanded"],[3,"opened","closed","expanded"],[1,"filtered"],[1,"unfiltered"],[3,"checked"],[3,"change","checked"],["checked","true"],["checked","true",3,"change"],[3,"value"]],template:function(i,n){i&1&&h(0,ht,54,42,"ng-container",1)},dependencies:[Ie,_e,de,ue,Se,be,ye,Te,ve,Ce,xe,Me,Pe,Oe,ke,$e,Ee,we,ce,le,pe,re,te,qe,he,Ve,Ae,Qe,Fe],styles:[".mat-expansion-panel[_ngcontent-%COMP%]{margin-top:14px;margin-right:14px}.mat-expansion-panel[_ngcontent-%COMP%]   section[_ngcontent-%COMP%]{margin-left:-10px}.mat-expansion-panel.panel-content-type[_ngcontent-%COMP%]{margin-top:20px}.mat-expansion-panel.panel-content-type[_ngcontent-%COMP%]   section[_ngcontent-%COMP%]{margin-left:0}.mat-expansion-panel[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]{list-style:none;padding-left:0;margin:0}.mat-expansion-panel[_ngcontent-%COMP%]   mat-panel-title[_ngcontent-%COMP%], .mat-expansion-panel[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{position:relative;line-height:40px;padding-left:40px}.mat-expansion-panel[_ngcontent-%COMP%]   mat-panel-title[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%], .mat-expansion-panel[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{position:absolute;left:0;top:8px}.mat-expansion-panel[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{cursor:pointer}.mat-expansion-panel[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{top:6px}.mat-expansion-panel[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{float:right;font-size:.8rem}.mat-expansion-panel[_ngcontent-%COMP%]   mat-checkbox[_ngcontent-%COMP%]{display:block}.mat-expansion-panel[_ngcontent-%COMP%]   mat-checkbox[_ngcontent-%COMP%]     label{min-width:220px}.mat-expansion-panel[_ngcontent-%COMP%]   mat-checkbox[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{margin-left:10px;position:absolute;right:0}.search-form[_ngcontent-%COMP%]{padding-top:20px;padding-bottom:10px;position:relative;clear:both;display:flex;flex-wrap:wrap}.search-form[_ngcontent-%COMP%]   .form-field-container[_ngcontent-%COMP%]{display:inline-flex;flex-direction:column;position:relative;margin-left:20px;padding-bottom:20px}.search-form[_ngcontent-%COMP%]   .form-field-container[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{top:8px}.search-form[_ngcontent-%COMP%]   .form-field-container.form-field-container-order-by[_ngcontent-%COMP%]{padding-right:40px}.search-form[_ngcontent-%COMP%]   .form-field-container.form-field-container-order-by[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{position:absolute;right:0}.search-form[_ngcontent-%COMP%]   .form-field-container.form-field-container-search-query[_ngcontent-%COMP%]{width:300px}.search-form[_ngcontent-%COMP%]   .form-field-container.form-field-container-search-query[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{position:absolute;right:0}.search-form[_ngcontent-%COMP%]   .form-field-container.form-field-container-search-query[_ngcontent-%COMP%]     .mat-mdc-form-field-infix{padding-right:50px}.search-form[_ngcontent-%COMP%]   .button-container-toggle-direction[_ngcontent-%COMP%]{margin-left:4px}app-paginator[_ngcontent-%COMP%]{float:right;padding-top:14px;padding-bottom:20px}"],changeDetection:0})}}return t})(),H=20,Je={page:1,limit:H,contentType:null,orderBy:He,aggregationBudget:null,facets:{genre:M,language:M,fileType:M,torrentSource:M,torrentTag:M,videoResolution:M,videoSource:M}},xt=t=>{let o=y(t,"query"),e=L(t,"facets"),i,n=y(t,"torrent");if(n){let a,r=y(t,"tab");Re.includes(r)&&(a=r),i={infoHash:n,tab:a}}return{queryString:o,orderBy:bt(t,!!o),contentType:St(t),limit:R(t,"limit")??H,page:R(t,"page")??1,selectedTorrent:i,facets:B.reduce((a,r)=>{let P=e?.includes(r.key)??!1,Ke=L(t,r.key);return r.patchInput(a,{active:P,filter:Ke})},Je.facets)}},Ct=t=>{let o=t.page,e=t.limit;o===1&&(o=void 0),e===H&&(e=void 0);let i=Ne(t)?void 0:t.orderBy,n;return i&&(n=i.descending?"1":"0"),f(f({query:t.queryString?encodeURIComponent(t.queryString):void 0,page:o,limit:e,content_type:t.contentType,order:i?.field,desc:n},t.selectedTorrent?{torrent:t.selectedTorrent.infoHash,tab:t.selectedTorrent.tab??void 0}:{}),yt(t.facets))},St=t=>{let o=y(t,"content_type");return o&&o in De?o:null},bt=(t,o)=>{let e=null,i=y(t,"desc");i==="1"?e=!0:i==="0"&&(e=!1);let n=y(t,"order");for(let a of D)if(a.field===n)return{field:n,descending:e??a.descending};return{field:o?"relevance":"published_at",descending:e??!0}},yt=t=>{let[o,e]=B.reduce((i,n)=>{let a=n.extractInput(t);return a.active?[[...i[0],n.key],a.filter?T(f({},i[1]),{[n.key]:a.filter}):i[1]]:i},[[],{}]);return f({facets:o.length?o.join(","):void 0},Object.fromEntries(Object.entries(e).map(([i,n])=>[i,encodeURIComponent(n.join(","))])))};export{gn as TorrentsSearchComponent};
